<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>FWYMo</title>
  <style>
    *,*::before,*::after{box-sizing:border-box}
    :root{
      --bg:#0b0c10;
      --card:#10121a;
      --card2:#0f1118;
      --tx:#f4f6ff;
      --mut:#a7adbf;
      --bd:#202436;

      --pri:#7c5cff;
      --pri2:#5a3bff;
      --ok:#27d7a1;
      --warn:#ffb020;

      --chip:#14182a;
      --chipOn:#1d2450;

      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --radius: 18px;
    }
    body{
      margin:0; color:var(--tx);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(124,92,255,.25), transparent 50%),
        radial-gradient(900px 500px at 90% 0%, rgba(39,215,161,.12), transparent 55%),
        var(--bg);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display","Segoe UI",Roboto,system-ui,sans-serif;
      -webkit-font-smoothing:antialiased;
    }
    a{color:inherit}
    .wrap{max-width:880px;margin:0 auto;padding:18px 14px 44px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:8px 4px 16px;
    }
    .brand{display:flex;flex-direction:column;gap:2px}
    .brand .t{font-weight:650;letter-spacing:.2px;font-size:18px}
    .brand .s{color:var(--mut);font-size:12px}
    .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .tag{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border:1px solid var(--bd);
      border-radius:999px;background:rgba(16,18,26,.65); color:var(--mut);
      font-size:12px
    }
    .btn{
      border:1px solid var(--bd);
      background:rgba(16,18,26,.65);
      color:var(--tx);
      border-radius:999px;
      padding:10px 12px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 1px 0 rgba(255,255,255,.05) inset;
    }
    .btn.primary{
      background:linear-gradient(135deg,var(--pri),var(--pri2));
      border-color:transparent;
    }
    .btn.ghost{background:transparent}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:860px){.grid{grid-template-columns:1fr 1fr}}
    .card{
      border:1px solid var(--bd);
      background:rgba(16,18,26,.72);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }
    .card h2{margin:2px 0 10px;font-size:14px;font-weight:650;letter-spacing:.2px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .label{color:var(--mut);font-size:12px;margin:6px 0 8px}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--bd);
      background:var(--chip);
      color:var(--tx);
      cursor:pointer;
      user-select:none;
      font-size:13px;
    }
    .chip.on{background:var(--chipOn); border-color:rgba(124,92,255,.55)}
    .chip small{color:var(--mut);font-size:12px}
    .chip.locked{
      opacity:.68;
      border-style:dashed;
      cursor:pointer;
    }
    .in{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--bd);
      background:rgba(10,12,18,.65);
      color:var(--tx);
      font-size:14px;
    }
    .in::placeholder{color:rgba(167,173,191,.6)}
    .range{width:min(360px, 74vw)}
    .mini{font-size:12px;color:var(--mut)}
    .hr{height:1px;background:rgba(32,36,54,.9);margin:12px 0}
    ul{margin:10px 0 0;padding-left:18px}
    li{margin:6px 0;color:rgba(244,246,255,.92)}
    .pill{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--bd);
      background:rgba(10,12,18,.55);
      color:var(--mut);
      font-size:12px
    }
    .kpi{display:flex;gap:8px;flex-wrap:wrap}
    .kpi .pill b{color:var(--tx);font-weight:650}
    .hide{display:none !important}
    .ad{
      border:1px dashed rgba(255,255,255,.15);
      border-radius:var(--radius);
      padding:14px;
      color:var(--mut);
      background:rgba(10,12,18,.35)
    }

    /* Modal */
    body.modalOpen{overflow:hidden}
    .modalBg{
      position:fixed; inset:0; background:rgba(0,0,0,.62);
      display:flex; align-items:flex-end; justify-content:center;
      padding:14px; z-index:999;
    }
    .modal{
      width:min(760px,100%);
      border-radius:22px;
      border:1px solid var(--bd);
      background:rgba(16,18,26,.94);
      box-shadow:var(--shadow);
      padding:14px;
      backdrop-filter: blur(12px);
    }
    .modalTop{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .modalTop .t{font-size:14px;font-weight:650}
    .modalGrid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
    @media(min-width:760px){.modalGrid{grid-template-columns:1fr 1fr}}
    .plan{
      border:1px solid var(--bd); border-radius:18px; padding:12px;
      background:rgba(10,12,18,.45);
    }
    .plan .name{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .plan .name b{font-size:14px}
    .plan .desc{color:var(--mut);font-size:12px;margin-top:6px;line-height:1.4}
    .lock{color:var(--warn);font-weight:650}

    /* Drawer (Panel) */
    .drawerBg{
      position:fixed; inset:0;
      background:rgba(0,0,0,.52);
      display:flex; align-items:flex-end; justify-content:center;
      padding:12px; z-index:998;
    }
    .drawer{
      width:min(760px,100%);
      border-radius:22px;
      border:1px solid var(--bd);
      background:rgba(16,18,26,.94);
      box-shadow:var(--shadow);
      padding:14px;
      backdrop-filter: blur(12px);
      max-height: 78vh;
      overflow:auto;
    }

    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:18px; z-index:1000;
      background:rgba(16,18,26,.92); border:1px solid var(--bd);
      padding:10px 12px; border-radius:999px; box-shadow:var(--shadow);
      color:var(--tx); font-size:12px;
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <div class="t" id="uiBrand">FWYMo</div>
      <div class="s" id="uiSub">Before you press play.</div>
    </div>
    <div class="right">
      <span class="tag" id="planTag">Free</span>
      <button class="btn" id="langBtn">JP</button>
      <button class="btn" id="planBtn">Plan</button>
    </div>
  </div>

  <div class="grid" id="mainGrid">
    <!-- INPUT -->
    <div class="card">
      <h2 id="uiBuild">Create</h2>

      <div class="label" id="uiMood">Mood</div>
      <div class="row" id="moodRow"></div>
      <div class="mini" id="moodHint"></div>

      <div class="label" id="uiSession">Session</div>
      <div class="row" id="sessionRow"></div>

      <div class="label" id="uiTargetLabel">Time</div>

      <div class="row" id="timeRow">
        <input class="range" id="minsRange" type="range" min="10" max="45" step="5" value="30" />
        <span class="pill"><b id="minsNum">30</b>&nbsp;<span id="uiMin">min</span></span>
        <span class="mini" id="timeHint"></span>
      </div>

      <div class="row hide" id="tracksRow">
        <input class="range" id="tracksRange" type="range" min="10" max="50" step="5" value="20" />
        <span class="pill"><b id="tracksNum">20</b>&nbsp;<span id="uiTracks">tracks</span></span>
        <span class="mini" id="tracksHint"></span>
      </div>

      <div class="label" id="uiVibe">Vibe</div>
      <input id="vibe" class="in" type="text" maxlength="60" placeholder="rain / sleepy / drive / midnight…" />
      <div class="mini" id="vibeHint"></div>

      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="createBtn">Create</button>
        <button class="btn" id="refineBtn" disabled>Refine</button>
        <span class="mini" id="quotaHint"></span>
      </div>

      <div class="hr"></div>

      <div class="row">
        <span class="pill">Pro / Studio <span class="lock">LOCKED</span></span>
        <span class="mini" id="soonText">MusicKit & AI later.</span>
      </div>
    </div>

    <!-- RESULT -->
    <div class="card">
      <h2 id="uiResult">Result</h2>

      <div id="emptyState" class="muted" style="color:var(--mut);margin-top:6px">
        Create a playlist to see the result.
      </div>

      <div id="resultWrap" class="hide">
        <div class="kpi" id="kpi"></div>
        <ul id="trackList"></ul>

        <div class="hr"></div>

        <div class="row">
          <button class="btn primary" id="openBtn">Open</button>
          <button class="btn" id="shareBtn">Share</button>
          <button class="btn" id="notesBtn">Notes</button>
          <button class="btn" id="upgradeBtn">Upgrade</button>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn" id="moreNewBtn">New</button>
          <button class="btn" id="moreSafeBtn">Safe</button>
          <button class="btn" id="moreEnergyBtn">Energy</button>
          <span class="mini" id="refineHint"></span>
        </div>

        <div class="hr"></div>

        <div class="ad" id="adBox">
          <b>Ad</b>
          <div class="muted" id="adText" style="margin-top:6px">Free only. (placeholder)</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Plan Modal -->
<div class="modalBg hide" id="planModalBg" aria-hidden="true">
  <div class="modal">
    <div class="modalTop">
      <div class="t" id="uiChoosePlan">Choose plan</div>
      <button class="btn" id="closePlanBtn">Close</button>
    </div>
    <div class="modalGrid">
      <div class="plan">
        <div class="name">
          <b>Free</b>
          <button class="btn" id="pickFreeBtn">Select</button>
        </div>
        <div class="desc" id="freeDesc">Time ≤ 45min · Refine 1/day · Share: Snapshot · Ads</div>
      </div>
      <div class="plan">
        <div class="name">
          <b>Plus</b>
          <button class="btn primary" id="pickPlusBtn">Select</button>
        </div>
        <div class="desc" id="plusDesc">Time ≤ 90min · Tracks mode · Refine 5/day · Notes · Share: View/Full</div>
      </div>
      <div class="plan">
        <div class="name">
          <b>Pro</b>
          <span class="lock">LOCKED</span>
        </div>
        <div class="desc" id="proDesc">MusicKit playlist creation (later)</div>
      </div>
      <div class="plan">
        <div class="name">
          <b>Studio</b>
          <span class="lock">LOCKED</span>
        </div>
        <div class="desc" id="studioDesc">AI interpretation / lyrics (later)</div>
      </div>
    </div>
  </div>
</div>

<!-- Drawer (Share / Notes / Shared View) -->
<div class="drawerBg hide" id="drawerBg" aria-hidden="true">
  <div class="drawer">
    <div class="modalTop">
      <div class="t" id="drawerTitle">Panel</div>
      <button class="btn" id="drawerCloseBtn">Close</button>
    </div>

    <!-- SHARE -->
    <div id="drawerShare" class="hide">
      <div class="label" id="uiShareAs">Share as</div>
      <div class="row">
        <button class="btn" id="shareSnap">Snapshot</button>
        <button class="btn" id="shareView">View</button>
        <button class="btn" id="shareFull">Full</button>
      </div>

      <div class="label" style="margin-top:12px">Link</div>
      <input id="shareUrl" class="in" type="text" readonly />

      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="copyLinkBtn">Copy</button>
        <button class="btn" id="openLinkBtn">Open</button>
        <span class="mini" id="shareHint"></span>
      </div>

      <div class="mini" style="margin-top:8px" id="shareExplain">
        Snapshot is SNS-safe. View requires FWYMo. Full is same-plan.
      </div>
    </div>

    <!-- NOTES -->
    <div id="drawerNotes" class="hide">
      <div class="row" style="justify-content:space-between">
        <div class="label" id="uiNotes">Notes</div>
        <span class="mini" id="notesMeta"></span>
      </div>

      <div id="notesLocked" class="muted" style="color:var(--mut)">
        Notes are available on <b>Plus</b>.
      </div>

      <div id="notesArea" class="hide">
        <input id="noteInput" class="in" type="text" maxlength="140" placeholder="140 chars max" />
        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="postNoteBtn">Post</button>
          <span class="mini" id="noteHint"></span>
        </div>
        <div class="hr"></div>
        <ul id="notesList"></ul>
      </div>
    </div>

    <!-- SHARED VIEW -->
    <div id="drawerShared" class="hide">
      <div class="muted" id="sharedMeta" style="color:var(--mut)"></div>
      <ul id="sharedTracks"></ul>
      <div class="hr"></div>
      <div class="row">
        <button class="btn primary" id="sharedOpenBtn">Open</button>
        <button class="btn" id="sharedBackBtn">Back</button>
      </div>
      <div class="mini" style="margin-top:8px" id="sharedFoot">
        Snapshot is view-only. Rebuild on FWYMo.
      </div>
    </div>
  </div>
</div>

<div class="toast hide" id="toast"></div>

<script>
/* =========================================================
  Helpers
========================================================= */
const $ = (id)=>document.getElementById(id);
function toast(msg){
  const el = $("toast");
  el.textContent = msg;
  el.classList.remove("hide");
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>el.classList.add("hide"), 950);
}
function setModalOpen(on){
  document.body.classList.toggle("modalOpen", on);
}

/* =========================================================
  i18n
========================================================= */
const I18N = {
  en:{
    sub:"Before you press play.",
    create:"Create",
    result:"Result",
    mood:"Mood",
    moodHint:"Tap again to clear.",
    session:"Session",
    time:"Time",
    tracks:"Tracks",
    min:"min",
    vibe:"Vibe",
    vibeHint:"Max 60 chars. Noise is ignored.",
    refine:"Refine",
    open:"Open",
    share:"Share",
    notes:"Notes",
    upgrade:"Upgrade",
    choosePlan:"Choose plan",
    close:"Close",
    plan:"Plan",
    freeDesc:"Time ≤ 45min · Refine 1/day · Share: Snapshot · Ads",
    plusDesc:"Time ≤ 90min · Tracks mode · Refine 5/day · Notes · Share: View/Full",
    proDesc:"MusicKit playlist creation (later)",
    studioDesc:"AI interpretation / lyrics (later)",
    soon:"MusicKit & AI later.",
    empty:"Create a playlist to see the result.",
    ad:"Free only. (placeholder)",
    panel:"Panel",
    shareAs:"Share as",
    snapshot:"Snapshot",
    view:"View",
    full:"Full",
    shareExplain:"Snapshot is SNS-safe. View requires FWYMo. Full is same-plan.",
    shareHintSnap:"SNS OK",
    shareHintView:"FWYMo View-only",
    shareHintFull:"Same plan",
    copied:"Copied",
    notesLocked:"Notes are available on Plus.",
    notePh:"140 chars max",
    post:"Post",
    noteNoLinks:"Links are not allowed.",
    newBtn:"New",
    safeBtn:"Safe",
    energyBtn:"Energy",
    refineLimit:"Daily limit reached.",
    vibeNoise:"Vibe looks like noise. Ignored.",
    sharedFoot:"Snapshot is view-only. Rebuild on FWYMo.",
    invalid:"Invalid link."
  },
  ja:{
    sub:"再生の前に、意図を作る。",
    create:"Create",
    result:"Result",
    mood:"Mood",
    moodHint:"同じの再タップで解除。",
    session:"Session",
    time:"Time",
    tracks:"Tracks",
    min:"分",
    vibe:"Vibe",
    vibeHint:"最大60文字。ノイズは無視。",
    refine:"Refine",
    open:"Open",
    share:"Share",
    notes:"Notes",
    upgrade:"Upgrade",
    choosePlan:"Plan",
    close:"Close",
    plan:"Plan",
    freeDesc:"Time ≤ 45分 · Refine 1回/日 · Share: Snapshot · 広告",
    plusDesc:"Time ≤ 90分 · Tracks解放 · Refine 5回/日 · Notes · Share: View/Full",
    proDesc:"MusicKit（後で）",
    studioDesc:"AI（後で）",
    soon:"MusicKit / AI は後で。",
    empty:"Createすると結果が出る。",
    ad:"Freeのみ（ダミー）",
    panel:"Panel",
    shareAs:"Share as",
    snapshot:"Snapshot",
    view:"View",
    full:"Full",
    shareExplain:"SnapshotはSNS向け。ViewはFWYMo内。Fullは同プラン限定。",
    shareHintSnap:"SNS OK",
    shareHintView:"FWYMo閲覧",
    shareHintFull:"同プラン",
    copied:"コピーした",
    notesLocked:"NotesはPlusで解放。",
    notePh:"140文字まで",
    post:"Post",
    noteNoLinks:"リンクは不可。",
    newBtn:"New",
    safeBtn:"Safe",
    energyBtn:"Energy",
    refineLimit:"本日の上限。",
    vibeNoise:"Vibeがノイズっぽいので無視した。",
    sharedFoot:"Snapshotは閲覧のみ。再生成はFWYMoで。",
    invalid:"リンクが壊れてる。"
  }
};

const LS = {
  plan:"fwymo_plan_v2",
  lang:"fwymo_lang_v2",
  refine:"fwymo_refine_count_v2",
  notes:"fwymo_notes_v2"
};

let state = {
  plan: localStorage.getItem(LS.plan) || "free",  // free | plus
  lang: localStorage.getItem(LS.lang) || "en",
  mood: null, // optional string
  session: "time", // time | tracks
  mins: 30,
  tracks: 20,
  last: null
};
function t(k){ return (I18N[state.lang]||I18N.en)[k] || k; }

function applyI18n(){
  $("uiSub").textContent = t("sub");
  $("uiBuild").textContent = t("create");
  $("uiResult").textContent = t("result");
  $("uiMood").textContent = t("mood");
  $("moodHint").textContent = t("moodHint");
  $("uiSession").textContent = t("session");
  $("uiTargetLabel").textContent = state.session==="time" ? t("time") : t("tracks");
  $("uiMin").textContent = t("min");
  $("uiTracks").textContent = t("tracks");
  $("uiVibe").textContent = t("vibe");
  $("vibeHint").textContent = t("vibeHint");
  $("createBtn").textContent = t("create");
  $("refineBtn").textContent = t("refine");
  $("openBtn").textContent = t("open");
  $("shareBtn").textContent = t("share");
  $("notesBtn").textContent = t("notes");
  $("upgradeBtn").textContent = t("upgrade");
  $("uiChoosePlan").textContent = t("choosePlan");
  $("closePlanBtn").textContent = t("close");
  $("planBtn").textContent = t("plan");
  $("freeDesc").textContent = t("freeDesc");
  $("plusDesc").textContent = t("plusDesc");
  $("proDesc").textContent = t("proDesc");
  $("studioDesc").textContent = t("studioDesc");
  $("soonText").textContent = t("soon");
  $("emptyState").textContent = t("empty");
  $("adText").textContent = t("ad");

  $("drawerTitle").textContent = t("panel");
  $("uiShareAs").textContent = t("shareAs");
  $("shareSnap").textContent = t("snapshot");
  $("shareView").textContent = t("view");
  $("shareFull").textContent = t("full");
  $("shareExplain").textContent = t("shareExplain");
  $("drawerCloseBtn").textContent = t("close");

  $("notesLocked").innerHTML = t("notesLocked").replace("Plus","<b>Plus</b>");
  $("noteInput").placeholder = t("notePh");
  $("postNoteBtn").textContent = t("post");
  $("moreNewBtn").textContent = t("newBtn");
  $("moreSafeBtn").textContent = t("safeBtn");
  $("moreEnergyBtn").textContent = t("energyBtn");
  $("sharedFoot").textContent = t("sharedFoot");

  $("langBtn").textContent = (state.lang==="en") ? "JP" : "EN";
}

/* =========================================================
  Plans / Limits
========================================================= */
const LIMITS = {
  free: { maxMins: 45, allowTracks:false, refinePerDay: 1, share:["snapshot"], notes:false, ads:true },
  plus: { maxMins: 90, allowTracks:true,  refinePerDay: 5, share:["snapshot","view","full"], notes:true, ads:false }
};

function todayKey(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const da = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}
function getRefineCount(){
  try{
    const o = JSON.parse(localStorage.getItem(LS.refine) || "{}");
    return o[todayKey()] || 0;
  }catch{ return 0; }
}
function incRefineCount(){
  const k = todayKey();
  let o = {};
  try{ o = JSON.parse(localStorage.getItem(LS.refine) || "{}"); }catch{}
  o[k] = (o[k]||0) + 1;
  localStorage.setItem(LS.refine, JSON.stringify(o));
}
function canRefine(){
  return getRefineCount() < LIMITS[state.plan].refinePerDay;
}

function applyPlan(){
  localStorage.setItem(LS.plan, state.plan);
  $("planTag").textContent = state.plan==="plus" ? "Plus" : "Free";

  // Session forcing
  if (!LIMITS[state.plan].allowTracks && state.session==="tracks"){
    state.session = "time";
  }

  // Time max
  const maxM = LIMITS[state.plan].maxMins;
  $("minsRange").max = String(maxM);
  state.mins = Math.min(state.mins, maxM);
  $("minsRange").value = String(state.mins);
  $("minsNum").textContent = String(state.mins);

  // Ads
  $("adBox").classList.toggle("hide", !LIMITS[state.plan].ads);

  // Quota
  $("quotaHint").textContent = `${t("refine")}: ${getRefineCount()}/${LIMITS[state.plan].refinePerDay} /day`;

  renderSessionChips();
  updateSessionUI();
  updateActionButtons();
  applyI18n();
}

/* =========================================================
  Mood / Session chips
========================================================= */
const MOODS = [
  { id:"Focus", label:"Focus", v:{ energy:.45,valence:.55,tempo:.55,focus:.9,familiarity:.8,warmth:.55,density:.45,dreaminess:.35,edge:.35,motion:.25,moodDepth:.35,modernity:.6 } },
  { id:"Night", label:"Night", v:{ energy:.30,valence:.30,tempo:.40,focus:.55,familiarity:.65,warmth:.45,density:.55,dreaminess:.80,edge:.45,motion:.20,moodDepth:.75,modernity:.5 } },
  { id:"Move",  label:"Move",  v:{ energy:.85,valence:.65,tempo:.85,focus:.40,familiarity:.60,warmth:.60,density:.60,dreaminess:.30,edge:.60,motion:.90,moodDepth:.45,modernity:.65 } },
  { id:"Calm",  label:"Calm",  v:{ energy:.25,valence:.55,tempo:.25,focus:.65,familiarity:.70,warmth:.65,density:.35,dreaminess:.55,edge:.20,motion:.15,moodDepth:.45,modernity:.55 } },
  { id:"Edge",  label:"Edge",  v:{ energy:.70,valence:.45,tempo:.70,focus:.45,familiarity:.50,warmth:.40,density:.65,dreaminess:.25,edge:.85,motion:.75,moodDepth:.55,modernity:.70 } }
];

function renderMoodChips(){
  const row = $("moodRow");
  row.innerHTML = "";
  MOODS.forEach(m=>{
    const b = document.createElement("div");
    b.className = "chip";
    b.textContent = m.label;
    b.onclick = ()=>{
      // same tap -> clear
      state.mood = (state.mood === m.id) ? null : m.id;
      renderMoodChips();
    };
    if (state.mood === m.id) b.classList.add("on");
    row.appendChild(b);
  });
}

function renderSessionChips(){
  const row = $("sessionRow");
  row.innerHTML = "";

  const mk = (id, label)=>{
    const b = document.createElement("div");
    const locked = (id==="tracks" && !LIMITS[state.plan].allowTracks);
    b.className = "chip" + (locked ? " locked" : "");
    b.innerHTML = `${label} <small>${id==="time" ? `≤${LIMITS[state.plan].maxMins}${t("min")}` : "10–50"}</small>`;
    b.onclick = ()=>{
      if (locked){
        openPlanModal();
        return;
      }
      state.session = id;
      updateSessionUI();
      applyI18n();
      renderSessionChips();
    };
    if (state.session === id && !locked) b.classList.add("on");
    return b;
  };

  row.appendChild(mk("time", t("time")));
  row.appendChild(mk("tracks", t("tracks")));
}

function updateSessionUI(){
  $("timeRow").classList.toggle("hide", state.session !== "time");
  $("tracksRow").classList.toggle("hide", state.session !== "tracks");
  $("uiTargetLabel").textContent = state.session==="time" ? t("time") : t("tracks");

  // hints
  $("timeHint").textContent = `≤ ${LIMITS[state.plan].maxMins}${t("min")}`;
  $("tracksHint").textContent = LIMITS[state.plan].allowTracks ? "10–50 (step 5)" : "Locked (Plus)";
}

/* =========================================================
  Vibe (noise guard)
========================================================= */
const AXES = ["energy","valence","tempo","focus","familiarity","warmth","density","dreaminess","edge","motion","moodDepth","modernity"];
function clamp01(x){ return Math.max(0, Math.min(1, x)); }
function vec(base=.5){ const v={}; AXES.forEach(k=>v[k]=base); return v; }
function vecClone(v){ const o={}; AXES.forEach(k=>o[k]=v[k]); return o; }
function vecApply(v,delta,mul=1){
  for(const k in delta){
    if (v[k]==null) continue;
    v[k]=clamp01(v[k]+delta[k]*mul);
  }
}

function looksLikeNoise(s){
  const t=(s||"").trim();
  if (!t) return false;
  const sym = (t.match(/[^a-zA-Z0-9\u3040-\u30ff\u4e00-\u9faf\s]/g)||[]).length;
  const len = t.length;
  const ratio = sym/Math.max(1,len);

  const noSpace = t.replace(/\s+/g,"");
  const alpha = noSpace.replace(/[^a-zA-Z]/g,"");
  const vowel = (alpha.match(/[aeiou]/gi)||[]).length;
  const vowelRatio = alpha.length ? vowel/alpha.length : 1;

  return (ratio > 0.35 && len >= 12) || (alpha.length >= 14 && vowelRatio < 0.2);
}
function intensity(text){
  const t=(text||"").toLowerCase();
  let m=1;
  if (/(めっちゃ|超|ガチ|最強|激|死ぬほど|とても|かなり|マジ|so|very|really|insane)/.test(t)) m*=1.25;
  if (/(ちょい|少し|軽め|ほどほど|控えめ|a bit|slightly|kinda)/.test(t)) m*=0.75;
  return Math.max(.55, Math.min(1.6,m));
}
function negation(text){
  const t=(text||"").toLowerCase();
  return /(じゃない|ではない|嫌|避けたい|なし|不要|いらん|no |not |without |avoid)/.test(t) ? 0.45 : 1.0;
}

const VIBE = [
  {k:["雨","rain","drizzle","曇","霧","mist","湿"], d:{dreaminess:+.15,warmth:-.12,valence:-.08,moodDepth:+.10}},
  {k:["晴","sun","clear","快晴"], d:{valence:+.15,warmth:+.10,dreaminess:-.05}},
  {k:["雪","cold","寒","winter"], d:{warmth:-.25,dreaminess:+.08,valence:-.05}},
  {k:["夏","暑","summer","hot"], d:{warmth:+.22,energy:+.10,tempo:+.05}},
  {k:["眠","sleepy","tired","だる","疲"], d:{energy:-.25,tempo:-.12,edge:-.10,dreaminess:+.06}},
  {k:["集中","study","work","作業","締切","focus"], d:{focus:+.25,density:-.08,tempo:+.05,familiarity:+.10}},
  {k:["ドライブ","drive","運転","散歩","walk","移動","commute"], d:{motion:+.22,tempo:+.12,energy:+.08}},
  {k:["明る","happy","元気","upbeat","上げ","party"], d:{energy:+.18,valence:+.20,tempo:+.10}},
  {k:["暗","sad","鬱","落","deep","midnight"], d:{valence:-.22,moodDepth:+.20,dreaminess:+.08}},
  {k:["チル","chill","lofi","まったり","relax"], d:{energy:-.14,tempo:-.10,edge:-.15,dreaminess:+.06}},
  {k:["攻め","hard","aggressive","尖","激"], d:{edge:+.25,energy:+.15,density:+.08}},
  {k:["新しい","未知","fresh","new","冒険"], d:{familiarity:-.25,modernity:+.10}},
  {k:["懐","nostalgia","昔","エモ","throwback"], d:{modernity:-.25,moodDepth:+.15,valence:-.05}},
  {k:["女性","female","girl","woman"], d:{warmth:+.06,valence:+.04}},
  {k:["男性","male","boy","man"], d:{edge:+.04,density:+.03}},
  {k:["クラブ","club","dance"], d:{tempo:+.15,energy:+.15,motion:+.12}}
];

function applyVibe(v, text){
  const raw=(text||"").trim();
  if (!raw) return {ignored:false};
  if (looksLikeNoise(raw)) return {ignored:true};

  const t=raw.toLowerCase();
  const mul=intensity(raw)*negation(raw);
  for(const r of VIBE){
    if (r.k.some(x=>t.includes(x.toLowerCase()))) vecApply(v,r.d,mul);
  }
  return {ignored:false};
}
function addJitter(v, amt){
  const keys=["energy","valence","tempo","warmth","density","dreaminess","edge","modernity","motion"];
  for(const k of keys){
    v[k]=clamp01(v[k]+(Math.random()*2-1)*amt);
  }
}

/* =========================================================
  Fake catalog (bigger)
========================================================= */
function makeTrack(id,title,artist,minutes,genre,traits){
  const v=vec(.5);
  for(const k in traits){ if (v[k]!=null) v[k]=clamp01(traits[k]); }
  return {id,title,artist,minutes,genre,v};
}
const GENRES = ["Pop","Hip-Hop","R&B","Rock","EDM","Jazz","Classical","Indie"];
const CATALOG = (()=>{
  const out=[];
  let n=1;
  function add(prefix, base, minutesPattern, genre){
    for(let i=0;i<22;i++){
      const id=`T${String(n++).padStart(4,"0")}`;
      const minutes=minutesPattern[i%minutesPattern.length];
      const jitter=(x,j=.09)=>clamp01(x+(Math.random()*2-1)*j);
      const traits={};
      for(const k of AXES) traits[k]=jitter(base[k]??.5);
      out.push(makeTrack(id, `${prefix} ${i+1}`, `${prefix} Artist ${(i%9)+1}`, minutes, genre, traits));
    }
  }
  const BASE = {};
  MOODS.forEach(m=>BASE[m.id]=m.v);

  add("Focus", BASE.Focus, [3,4,4,5], "Indie");
  add("Night", BASE.Night, [3,4,5,5], "R&B");
  add("Move",  BASE.Move,  [3,3,4,4,5], "EDM");
  add("Calm",  BASE.Calm,  [3,4,5,6], "Jazz");
  add("Edge",  BASE.Edge,  [2,3,3,4], "Hip-Hop");

  add("Pop",   {...BASE.Focus, valence:.7, modernity:.72}, [3,3,4,4], "Pop");
  add("Rock",  {...BASE.Edge, tempo:.6, warmth:.45}, [3,4,4,5], "Rock");
  add("Classic",{...BASE.Calm, focus:.55, modernity:.35}, [4,5,6,7], "Classical");

  return out;
})();

/* =========================================================
  Picker (time/tracks)
========================================================= */
function dist2(a,b){
  let s=0;
  for(const k of AXES){
    const d=(a[k]??.5)-(b[k]??.5);
    s+=d*d;
  }
  return s;
}
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function pick(targetVec, mode, targetMinutes, targetTracks){
  const poolCap = state.plan==="plus" ? 220 : 120;
  const mixCap  = state.plan==="plus" ? 140 : 70;

  const scored = CATALOG.map(t=>({t, s:dist2(t.v,targetVec)})).sort((a,b)=>a.s-b.s);
  const pool = scored.slice(0, Math.min(poolCap, scored.length));
  const mix = shuffle(pool.slice(0, Math.min(mixCap, pool.length)));

  const picked=[];
  let total=0;
  const artistCount=new Map();
  const maxTracksFill = state.plan==="plus" ? 60 : 30;
  const minutesCap = LIMITS[state.plan].maxMins;

  const canTake=(t)=>{
    const c=artistCount.get(t.artist)||0;
    return c<3;
  };
  const take=(t)=>{
    picked.push(t); total+=t.minutes;
    artistCount.set(t.artist,(artistCount.get(t.artist)||0)+1);
  };

  for(const it of mix){
    if(picked.length>=maxTracksFill) break;
    const t=it.t;
    if(!canTake(t)) continue;

    if(mode==="time"){
      if(total + t.minutes > targetMinutes) continue;
      take(t);
    }else{
      if(picked.length>=targetTracks) break;
      if(total + t.minutes > minutesCap) continue;
      take(t);
    }
  }
  return {tracks:picked, total};
}

/* =========================================================
  Share token (no DB)
========================================================= */
function base64urlEncode(str){
  const b64 = btoa(unescape(encodeURIComponent(str)));
  return b64.replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
}
function base64urlDecode(s){
  const b64 = s.replace(/-/g,"+").replace(/_/g,"/") + "===".slice((s.length+3)%4);
  return decodeURIComponent(escape(atob(b64)));
}
function playlistSignature(pl){
  const ids = pl.tracks.map(x=>x.id).join(",");
  return base64urlEncode(`${pl.mood||"Auto"}|${pl.mode}|${pl.target}|${ids}`).slice(0,18);
}
function makeShareLink(level, pl){
  const payload = {
    v:1,
    level,
    mood: pl.mood || null,
    mode: pl.mode,
    target: pl.target,
    total: pl.total,
    vibe: pl.vibe || "",
    vibeIgnored: !!pl.vibeIgnored,
    sig: pl.sig,
    tracks: pl.tracks.map(x=>({t:x.title,a:x.artist,m:x.minutes,g:x.genre}))
  };
  const token = base64urlEncode(JSON.stringify(payload));
  const base = location.origin + location.pathname;
  return `${base}#/s/${level}/${token}`;
}

/* =========================================================
  Notes (local beta)
========================================================= */
function loadNotes(){
  try{ return JSON.parse(localStorage.getItem(LS.notes)||"{}"); }catch{ return {}; }
}
function saveNotes(o){ localStorage.setItem(LS.notes, JSON.stringify(o)); }
function getNotes(sig){
  const o=loadNotes(); return o[sig] || [];
}
function addNote(sig, text){
  const o=loadNotes();
  const arr=o[sig]||[];
  arr.unshift({text, ts:new Date().toISOString()});
  o[sig]=arr.slice(0,60);
  saveNotes(o);
}

/* =========================================================
  UI rendering
========================================================= */
function setKPI(pl){
  $("kpi").innerHTML = "";
  const pill = (html)=>{
    const s=document.createElement("span");
    s.className="pill";
    s.innerHTML=html;
    $("kpi").appendChild(s);
  };
  const mood = pl.mood ? pl.mood : "Auto";

  // ALWAYS show both time+tracks in KPI (you wanted both visible)
  pill(`<b>${mood}</b>`);
  if (pl.mode==="time"){
    pill(`<b>${pl.target}${t("min")}</b> target`);
    pill(`<b>~${pl.total}${t("min")}</b> result`);
    pill(`<b>${pl.tracks.length}</b> ${t("tracks")}`);
  } else {
    pill(`<b>${pl.target}</b> ${t("tracks")} target`);
    pill(`<b>${pl.tracks.length}</b> ${t("tracks")} result`);
    pill(`<b>~${pl.total}${t("min")}</b>`);
  }

  // vibe status
  if ((pl.vibe||"").trim()){
    if (pl.vibeIgnored){
      pill(`<span class="muted">${t("vibeNoise")}</span>`);
    } else {
      const v = pl.vibe.trim().replace(/</g,"&lt;").replace(/>/g,"&gt;");
      pill(`<span class="muted">vibe</span> “${v}”`);
    }
  }
}

function renderTracks(listEl, tracks){
  listEl.innerHTML="";
  tracks.forEach(x=>{
    const li=document.createElement("li");
    li.textContent = `${x.title} — ${x.artist} (${x.minutes}m) · ${x.genre}`;
    listEl.appendChild(li);
  });
}

function updateActionButtons(){
  const has = !!state.last;

  $("emptyState").classList.toggle("hide", has);
  $("resultWrap").classList.toggle("hide", !has);

  // refine quota
  const ok = canRefine();
  $("refineBtn").disabled = !has || !ok;
  $("moreNewBtn").disabled = !has || !ok;
  $("moreSafeBtn").disabled = !has || !ok;
  $("moreEnergyBtn").disabled = !has || !ok;

  $("refineHint").textContent = ok ? "" : t("refineLimit");
  $("quotaHint").textContent = `${t("refine")}: ${getRefineCount()}/${LIMITS[state.plan].refinePerDay} /day`;

  // upgrade button only shows if Free
  $("upgradeBtn").classList.toggle("hide", state.plan !== "free");
}

/* =========================================================
  Build vector / Create playlist
========================================================= */
function buildVector(vibeText){
  const v=vec(.5);
  if (state.mood){
    const m = MOODS.find(x=>x.id===state.mood);
    if (m) Object.assign(v, m.v);
  }
  const res = applyVibe(v, vibeText||"");
  addJitter(v, (vibeText||"").trim()? .045 : .08);
  AXES.forEach(k=>v[k]=clamp01(v[k]));
  return {v, vibeIgnored:res.ignored};
}

function createPlaylist(extraDelta=null){
  const raw = ($("vibe").value||"").trim();
  const {v, vibeIgnored} = buildVector(raw);

  if (extraDelta) vecApply(v, extraDelta, 1);

  const mode = state.session;
  const target = (mode==="time") ? state.mins : state.tracks;

  const out = pick(v, mode, state.mins, state.tracks);

  const pl = {
    mood: state.mood,
    mode,
    target,
    vibe: raw,
    vibeIgnored,
    vec: vecClone(v),
    tracks: out.tracks,
    total: out.total
  };
  pl.sig = playlistSignature(pl);

  state.last = pl;

  setKPI(pl);
  renderTracks($("trackList"), pl.tracks);

  // Open (beta: Apple Music search)
  $("openBtn").onclick = ()=>{
    const q =
      (pl.vibe && !pl.vibeIgnored) ? pl.vibe :
      (pl.mood ? `${pl.mood} playlist` : "playlist");
    const url = `https://music.apple.com/jp/search?term=${encodeURIComponent(q)}`;
    window.open(url, "_blank");
  };

  updateActionButtons();

  // subtle vibe toast only once per session
  if (pl.vibeIgnored && !createPlaylist._warned){
    createPlaylist._warned = true;
    toast(t("vibeNoise"));
  }
}

/* =========================================================
  Drawer (Panel)
========================================================= */
function drawerOpen(which){
  $("drawerBg").classList.remove("hide");
  $("drawerBg").setAttribute("aria-hidden","false");
  setModalOpen(true);

  // hide all
  $("drawerShare").classList.add("hide");
  $("drawerNotes").classList.add("hide");
  $("drawerShared").classList.add("hide");

  if (which==="share") $("drawerShare").classList.remove("hide");
  if (which==="notes") $("drawerNotes").classList.remove("hide");
  if (which==="shared") $("drawerShared").classList.remove("hide");

  $("drawerTitle").textContent = t("panel");
}
function drawerClose(){
  $("drawerBg").classList.add("hide");
  $("drawerBg").setAttribute("aria-hidden","true");
  setModalOpen(false);
}
$("drawerCloseBtn").onclick = drawerClose;
$("drawerBg").addEventListener("click",(e)=>{
  if (e.target === $("drawerBg")) drawerClose();
});

/* =========================================================
  Share / Notes
========================================================= */
function doShare(level){
  if (!state.last) return;

  const allowed = LIMITS[state.plan].share.includes(level);
  if (!allowed){
    openPlanModal();
    return;
  }

  const url = makeShareLink(level, state.last);
  $("shareUrl").value = url;

  const hint =
    level==="snapshot" ? t("shareHintSnap") :
    level==="view" ? t("shareHintView") : t("shareHintFull");

  $("shareHint").textContent = hint;

  drawerOpen("share");
}

function showNotes(){
  if (!state.last) return;

  $("notesMeta").textContent = `#${state.last.sig}`;

  const isPlus = LIMITS[state.plan].notes;
  $("notesLocked").classList.toggle("hide", isPlus);
  $("notesArea").classList.toggle("hide", !isPlus);

  // render list
  const list = $("notesList");
  list.innerHTML = "";
  const notes = getNotes(state.last.sig);
  notes.forEach(n=>{
    const li=document.createElement("li");
    li.textContent = n.text;
    list.appendChild(li);
  });

  $("noteHint").textContent = "";
  drawerOpen("notes");
}

/* =========================================================
  Plan modal
========================================================= */
function openPlanModal(){
  $("planModalBg").classList.remove("hide");
  $("planModalBg").setAttribute("aria-hidden","false");
  setModalOpen(true);
}
function closePlanModal(){
  $("planModalBg").classList.add("hide");
  $("planModalBg").setAttribute("aria-hidden","true");
  setModalOpen(false);
}
$("planBtn").onclick = openPlanModal;
$("closePlanBtn").onclick = closePlanModal;
$("planModalBg").addEventListener("click",(e)=>{
  if (e.target === $("planModalBg")) closePlanModal();
});
$("pickFreeBtn").onclick = ()=>{ state.plan="free"; applyPlan(); closePlanModal(); };
$("pickPlusBtn").onclick = ()=>{ state.plan="plus"; applyPlan(); closePlanModal(); };

/* =========================================================
  Routing: shared link
========================================================= */
function showShared(level, token){
  let payload=null;
  try{ payload = JSON.parse(base64urlDecode(token)); }catch(e){}
  if (!payload || !payload.tracks){
    $("sharedMeta").textContent = t("invalid");
    $("sharedTracks").innerHTML = "";
    drawerOpen("shared");
    return;
  }

  const viewerIsPlus = (state.plan==="plus");

  // enforce: downgrade if viewer not plus
  let effLevel = level;
  if ((level==="full" || level==="view") && !viewerIsPlus) effLevel = "snapshot";

  const mood = payload.mood || "Auto";
  const mode = payload.mode;
  const target = payload.target;
  const total = payload.total || 0;

  let meta = "";
  if (effLevel==="snapshot"){
    meta = `${mood} · ${payload.tracks.length} tracks · ~${total}${t("min")}`;
  } else {
    meta = `${mood} · ${mode==="time" ? `${target}${t("min")}` : `${target} ${t("tracks")}`} · ${payload.tracks.length} tracks · ~${total}${t("min")}`;
  }

  // vibe visibility
  const vibe = (payload.vibe||"").trim();
  if (effLevel==="full"){
    if (vibe && !payload.vibeIgnored) meta += ` · vibe: "${vibe}"`;
    if (payload.vibeIgnored) meta += ` · vibe: (ignored)`;
  } else if (effLevel==="view"){
    if (vibe) meta += ` · vibe: "•••"`;
  }

  $("sharedMeta").textContent = meta;

  const ul = $("sharedTracks");
  ul.innerHTML="";
  payload.tracks.forEach(x=>{
    const li=document.createElement("li");
    li.textContent = `${x.t} — ${x.a} (${x.m}m) · ${x.g}`;
    ul.appendChild(li);
  });

  $("sharedOpenBtn").onclick = ()=>{
    const q = (vibe && effLevel!=="snapshot" && !payload.vibeIgnored) ? vibe : `${mood} playlist`;
    window.open(`https://music.apple.com/jp/search?term=${encodeURIComponent(q)}`, "_blank");
  };
  $("sharedBackBtn").onclick = ()=>{
    location.hash = "#/";
    drawerClose();
  };

  drawerOpen("shared");
}

function route(){
  const h = location.hash || "#/";
  const m = h.match(/^#\/s\/(snapshot|view|full)\/([a-z0-9\-_]+)/i);
  if (m){
    showShared(m[1], m[2]);
  }
}
window.addEventListener("hashchange", route);

/* =========================================================
  Buttons & interactions
========================================================= */
$("langBtn").onclick = ()=>{
  state.lang = (state.lang==="en") ? "ja" : "en";
  localStorage.setItem(LS.lang, state.lang);
  applyI18n();
  renderSessionChips();
};

$("minsRange").addEventListener("input", ()=>{
  state.mins = parseInt($("minsRange").value,10);
  $("minsNum").textContent = String(state.mins);
});
$("tracksRange").addEventListener("input", ()=>{
  state.tracks = parseInt($("tracksRange").value,10);
  $("tracksNum").textContent = String(state.tracks);
});

$("createBtn").onclick = ()=>{
  createPlaylist(null);
};

$("refineBtn").onclick = ()=>{
  if (!state.last) return;
  if (!canRefine()) return;
  incRefineCount();
  applyPlan();
  createPlaylist(null);
};

function refine(delta){
  if (!state.last) return;
  if (!canRefine()) return;
  incRefineCount();
  applyPlan();
  createPlaylist(delta);
}
$("moreNewBtn").onclick = ()=> refine({familiarity:-0.18, modernity:+0.10});
$("moreSafeBtn").onclick = ()=> refine({familiarity:+0.18, edge:-0.12, dreaminess:+0.06});
$("moreEnergyBtn").onclick = ()=> refine({energy:+0.16, tempo:+0.10, motion:+0.10});

$("shareBtn").onclick = ()=>{
  if (!state.last) return;
  drawerOpen("share");
};
$("notesBtn").onclick = ()=>{
  if (!state.last) return;
  showNotes();
};
$("upgradeBtn").onclick = openPlanModal;

$("shareSnap").onclick = ()=> doShare("snapshot");
$("shareView").onclick = ()=> doShare("view");
$("shareFull").onclick = ()=> doShare("full");

$("copyLinkBtn").onclick = async ()=>{
  const v = $("shareUrl").value;
  if (!v) return;
  try{
    await navigator.clipboard.writeText(v);
    toast(t("copied"));
  }catch{
    $("shareUrl").focus();
    $("shareUrl").select();
  }
};
$("openLinkBtn").onclick = ()=>{
  const v = $("shareUrl").value;
  if (!v) return;
  window.open(v, "_blank");
};

$("postNoteBtn").onclick = ()=>{
  if (!state.last) return;
  if (!LIMITS[state.plan].notes) { openPlanModal(); return; }

  const txt = ($("noteInput").value||"").trim();
  if (!txt) return;

  if (/(https?:\/\/|www\.)/i.test(txt)){
    $("noteHint").textContent = t("noteNoLinks");
    return;
  }

  addNote(state.last.sig, txt);
  $("noteInput").value="";
  $("noteHint").textContent = "";
  showNotes();
};

/* =========================================================
  Init
========================================================= */
(function init(){
  renderMoodChips();
  renderSessionChips();

  // initial slider values
  $("minsRange").value = String(state.mins);
  $("minsNum").textContent = String(state.mins);
  $("tracksRange").value = String(state.tracks);
  $("tracksNum").textContent = String(state.tracks);

  // plan apply
  applyPlan();
  applyI18n();
  updateSessionUI();
  updateActionButtons();

  // vibe live hint (soft)
  $("vibe").addEventListener("input", ()=>{
    const v = ($("vibe").value||"").trim();
    if (!v) { $("vibeHint").textContent = t("vibeHint"); return; }
    if (looksLikeNoise(v)) $("vibeHint").textContent = t("vibeNoise");
    else $("vibeHint").textContent = t("vibeHint");
  });

  // route shared link
  route();
})();
</script>
</body>
</html>
